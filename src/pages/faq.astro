---
import Layout from '../layouts/Layout.astro';
import HeroPage from '../components/HeroPage.astro';
import Accordion from '../components/Accordion.astro';
import { getEntry } from 'astro:content';
import siteInfo from '../data/site-info.json';

const page = await getEntry('pages', 'faq');
if (!page) throw new Error('Page not found: faq');
const { body } = page;

const heroData = siteInfo.hero_pages.faq;

// Parser le contenu Markdown pour extraire les sections
const sections: { category: string; questions: { question: string; answer: string }[] }[] = [];
const lines = body.split('\n');
let currentCategory = '';
let currentQuestion = '';
let currentAnswer: string[] = [];
let questions: { question: string; answer: string }[] = [];

for (let i = 0; i < lines.length; i++) {
  const line = lines[i];

  // Nouvelle catégorie (## titre)
  if (line.startsWith('## ') && !line.includes('Vous n\'avez pas trouvé')) {
    // Sauvegarder la question précédente si elle existe
    if (currentQuestion && currentAnswer.length > 0) {
      questions.push({ question: currentQuestion, answer: currentAnswer.join('\n').trim() });
      currentAnswer = [];
    }

    // Sauvegarder la catégorie précédente si elle existe
    if (currentCategory && questions.length > 0) {
      sections.push({ category: currentCategory, questions: [...questions] });
      questions = [];
    }

    currentCategory = line.replace('## ', '').trim();
    currentQuestion = '';
  }
  // Nouvelle question (### question)
  else if (line.startsWith('### ')) {
    // Sauvegarder la question précédente
    if (currentQuestion && currentAnswer.length > 0) {
      questions.push({ question: currentQuestion, answer: currentAnswer.join('\n').trim() });
      currentAnswer = [];
    }
    currentQuestion = line.replace('### ', '').trim();
  }
  // Contenu de la réponse
  else if (currentQuestion && line.trim() !== '') {
    currentAnswer.push(line);
  }
}

// Sauvegarder la dernière question et catégorie
if (currentQuestion && currentAnswer.length > 0) {
  questions.push({ question: currentQuestion, answer: currentAnswer.join('\n').trim() });
}
if (currentCategory && questions.length > 0) {
  sections.push({ category: currentCategory, questions });
}

// Fonction pour convertir markdown simple en HTML
function simpleMarkdownToHtml(text: string): string {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^\d+\.\s(.+)$/gm, '<li>$1</li>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
}
---

<Layout
  titre={page.data.titre}
  description={page.data.description}
>
  <HeroPage
    titre={heroData.titre}
    soustitre={heroData.soustitre}
    image={heroData.image}
  />

  <section class="section">
    <div class="container">
      <div class="faq-header">
        <h1 style="display: none;">{page.data.titre}</h1>
        <p>Trouvez rapidement les réponses à vos questions</p>
      </div>

      <div class="faq-content">
        {sections.map((section) => (
          <div class="faq-category">
            <h2 class="category-title">{section.category}</h2>
            <div class="accordion-list">
              {section.questions.map((item, index) => (
                <Accordion question={item.question} index={`${section.category}-${index}`}>
                  <div set:html={`<p>${simpleMarkdownToHtml(item.answer)}</p>`} />
                </Accordion>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div class="faq-footer">
        <h3>Vous n'avez pas trouvé de réponse ?</h3>
        <p>N'hésitez pas à nous contacter directement, nous nous ferons un plaisir de répondre à toutes vos questions !</p>
        <a href="/contact" class="btn">Nous contacter</a>
      </div>
    </div>
  </section>

  <script>
    // Script pour gérer les accordéons
    document.addEventListener('DOMContentLoaded', () => {
      const accordionHeaders = document.querySelectorAll('.accordion-header');

      accordionHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const isExpanded = header.getAttribute('aria-expanded') === 'true';
          header.setAttribute('aria-expanded', String(!isExpanded));
        });
      });
    });
  </script>
</Layout>

<style>
  .faq-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
  }

  .faq-header h1 {
    font-size: clamp(2.5rem, 5vw, 3.5rem);
    color: var(--color-text);
    font-weight: 700;
    margin-bottom: var(--spacing-md);
    position: relative;
    display: inline-block;
    padding-bottom: var(--spacing-sm);
  }

  .faq-header h1::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: var(--color-primary);
    border-radius: 2px;
  }

  .faq-header p {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
  }

  .faq-content {
    max-width: 900px;
    margin: 0 auto;
  }

  .faq-category {
    margin-bottom: var(--spacing-2xl);
  }

  .category-title {
    color: var(--color-primary);
    font-size: 1.75rem;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
  }

  .accordion-list {
    margin-top: var(--spacing-lg);
  }

  .faq-footer {
    text-align: center;
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-xl);
    background: var(--color-dark-lighter);
    border-radius: var(--radius-lg);
  }

  .faq-footer h3 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-sm);
  }

  .faq-footer p {
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-lg);
  }

  @media (max-width: 768px) {
    .faq-content {
      padding: 0 var(--spacing-md);
    }

    .category-title {
      font-size: 1.5rem;
    }
  }
</style>
